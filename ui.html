<!-- include Vue 2.x -->
<script src="https://cdn.jsdelivr.net/npm/vue@2/dist/vue.js"></script>
<script src="https://unpkg.com/v-tooltip"></script>

<style>
    body {
        margin: 0;
        padding: 0;
        font-family: inter, -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, "Apple Color Emoji", Arial, sans-serif, "Segoe UI Emoji", "Segoe UI Symbol";
    }

    .input {
        background: #FFFFFF;
        border: none;
        box-shadow: inset 0 0 0 1px #E5E5E5;
        box-sizing: border-box;
        border-radius: 2px;
        padding: 0 10px;
        color: rgba(0, 0, 0, 0.85);
        font-size: 12px;
        line-height: 18px;
        transition: box-shadow 100ms ease;
    }

    .input:hover {
        border: none;
        border-radius: 2px;
        box-shadow: inset 0 0 0 2px #24A0FB;
    }

    .input:focus {
        border: none;
        border-radius: 2px;
        box-shadow: inset 0 0 0 2px #24A0FB;
    }

    .input::placeholder {
        color: rgba(0, 0, 0, .25);
    }

    .button {
        display: flex;
        flex-direction: row;
        justify-content: center;
        align-items: center;
        padding: 6px 16px;
        border-radius: 2px;
        font-size: 12px;
        line-height: 18px;
        border: none;
        transition: all 100ms ease;
        user-select: none;
        cursor: pointer;
        text-decoration: none;
    }

    .button-primary {
        background: #18A0FB;
        color: #FFF;
    }

    .button-primary:hover {
        background: #0677bd;
    }

    .button-secondary {
        background: #FFF;
        color: rgba(0, 0, 0, .85);
        box-shadow: inset 0 0 0 1px #E5E5E5;
    }

    .button-secondary:hover {
        background: #FFF;
        color: #18A0FB;
        box-shadow: inset 0 0 0 1px #18A0FB;
    }

    .button-link {
        padding: 6px 8px;
        background: #FFF;
        color: #18A0FB;
    }

    .button-link:hover {
        background: #FFF;
        color: #0677bd;
    }

    #app>div {
        left: 0;
        right: 0;
        height: 100%;
        padding: 0;
        margin: 0;
    }

    .current-select {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        z-index: 99;

        display: flex;
        flex-direction: row;
        align-items: center;
        padding: 0;

        background: rgba(235, 235, 235, 0.9);
        backdrop-filter: blur(16px);

        border-bottom: 1px #E0E0E0 solid;
    }

    .main {
        display: flex;
        flex-direction: column;
        align-items: flex-start;

        flex: none;
        order: 2;
        align-self: stretch;
        flex-grow: 1;
        padding: 46px 12px 58px;

        overflow: auto;
    }

    .footer {
        position: fixed;
        left: 0;
        right: 0;
        bottom: 0;
        z-index: 99;

        /* Auto layout */
        display: flex;
        flex-direction: row;
        justify-content: space-between;
        align-items: center;
        padding: 8px 12px 9px; /* 不知为何，下方少了1个像素 */

        background: rgba(255, 255, 255, .8);
        backdrop-filter: blur(16px);

        border-top: 1px #E0E0E0 solid;
    }

    .loading {
        position: fixed;
        left: 0;
        right: 0;
        top: 0;
        bottom: 0;
        background: white;
        z-index: 999;

        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;

        margin-top: 35px;
        font-size: 14px;
        color: rgba(0, 0, 0, .65);
    }

    .loading-icon {
        animation: always-rotating 1.4s linear infinite;
        flex: none;
        order: 0;
        flex-grow: 0;
    }

    @keyframes always-rotating {
        100% {
            transform: rotate(360deg)
        }
    }

    .empty {
        position: fixed;
        left: 0;
        right: 0;
        top: 0;
        bottom: 0;
        background: white;
        z-index: 999;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;

        margin-top: 35px;
        font-size: 14px;
        color: rgba(0, 0, 0, .65);
    }

    /* ============ */

    .settings {
        padding: 12px;
        display: flex;
        flex-direction: column;
        align-items: flex-start;
        color: rgba(0, 0, 0, 0.85);
    }

    .settings>div {
        flex: none;
        align-self: stretch;
        flex-grow: 0;
        margin-bottom: 16px;
    }

    .settings h2 {
        margin: 0;
        font-weight: 700;
        font-size: 32px;
        line-height: 40px;
        user-select: none;
    }

    .settings .sub-title {
        color: rgba(0, 0, 0, 0.65);
        font-weight: 400;
        padding-top: 4px;
        user-select: none;
    }

    .settings p {
        font-size: 14px;
        font-weight: 600;
        margin: 0;
        user-select: none;
    }

    .settings .input-area {
        display: flex;
        flex-direction: column;
        align-items: flex-start;
        padding: 0px 0px 8px;
    }

    .settings .input {
        flex: none;
        height: 30px;
        font-size: 14px;
        line-height: 30px;
        flex-grow: 0;
        align-self: stretch;
        margin-top: 4px;
        margin-bottom: 16px;
    }

    .color-red {
        color: #E64340 !important;
    }

    .button-group {
        /* Auto layout */
        display: flex;
        flex-direction: row;
        align-items: flex-start;
        padding: 0;
    }

    .button-group .button {
        flex: none;
        order: 0;
        flex-grow: 0;
        margin-right: 8px;
    }

    .current-select div {
        flex: none;
        order: 0;
        flex-grow: 1;
        margin: 0 0;
    }

    .current-select .current-select-name {
        display: flex;
        flex-direction: row;
        align-items: center;
        padding: 8px 12px 8px;

        flex-grow: 1;

        font-size: 12px;
        line-height: 17px;
    }

    .current-select .current-select-name svg {
        flex: none;
        order: 0;
        flex-grow: 0;
        margin: 0 4px 0 0;
    }

    .current-select .current-select-name p {
        flex: none;
        order: 1;
        flex-grow: 1;
        margin: 0;
        user-select: none;
        text-overflow: ellipsis;
    }

    .current-select button {
        display: flex;
        flex-direction: row;
        align-items: flex-start;
        padding: 10px;
        flex-grow: 0;
        background: none;
        border: none;
        cursor: pointer;
        transition: background-color 100ms ease;
    }

    .current-select button:hover {
        background: rgba(0, 0, 0, 0.05);
    }

    .title {
        display: flex;
        flex-direction: row;
        align-items: center;
        padding-bottom: 12px;

        flex: none;
        order: 0;
        align-self: stretch;
        flex-grow: 0;
    }

    .title svg {
        transition: background-color 100ms ease;
        border-radius: 2px;
    }

    .title svg:hover {
        background-color: rgba(0, 0, 0, 0.05);
    }

    .title .input {
        margin-left: 8px;
        font-size: 14px;
        line-height: 20px;
        height: 30px;
        flex: none;
        order: 1;
        flex-grow: 1;
    }

    .selected {
        padding: 0 0 8px;
        display: flex;
        flex-direction: row;
        align-items: flex-start;
        flex-flow: wrap;
    }

    .selected .tag {
        margin: 0 4px 4px 0;
        flex: none;
        flex-grow: 0;
    }

    .selected .tag svg {
        padding: 0 4px 0 2px;
        cursor: pointer;
    }

    .tree {
        border-top: 1px solid #E0E0E0;
        padding: 12px 0 0 0;

        display: flex;
        flex-direction: column;
        align-items: flex-start;

        flex: none;
        order: 2;
        align-self: stretch;
        flex-grow: 0;

        user-select: none;
    }

    .tree>ul {
        /* Auto layout */
        display: flex;
        flex-direction: column;
        align-items: flex-start;
        padding: 0;
        margin: 0;
        /* Inside auto layout */
        flex: none;
        order: 0;
        align-self: stretch;
        flex-grow: 0;
    }

    .tree li {
        display: block;
    }

    .tree>ul>div {
        font-weight: 600;
        font-size: 14px;
        line-height: 22px;

        display: flex;
        flex-direction: row;
        justify-content: space-between;
        align-items: center;
        padding: 6px 4px 6px 8px;

        flex: none;
        order: 0;
        align-self: stretch;
        flex-grow: 0;
        margin: 0 0;

        transition: background-color 100ms ease;
    }

    .tree>ul>li {
        flex: none;
        align-self: stretch;
        flex-grow: 0;
    }

    .tree>ul>div:hover {
        background-color: rgba(0, 0, 0, 0.05);
        border-radius: 3px;
    }

    .tree>ul>div .icon-fold {
        transition: transform 100ms ease;
        flex: none;
        order: 0;
        flex-grow: 0;
        margin-right: 4px;
    }

    .tree-extra-area {
        display: flex;
        flex-direction: row;
        align-items: flex-start;
        padding: 0;
        flex: none;
        order: 1;
        flex-grow: 0;
    }

    .tree-extra-operation {
        margin-left: 4px;
        flex: none;
        flex-grow: 0;
        border-radius: 2px;
        padding: 4px;
        transition: background-color 100ms ease;
        cursor: pointer;
        animation-name: easein;
        animation-duration: 100ms;
    }

    .tree-extra-operation:hover {
        background-color: rgba(0, 0, 0, 0.05);
    }

    @keyframes easein {
        from {opacity: 0;}
        to {opacity: 1;}
    }

    .tree>ul>div>span {
        /* Auto layout */
        display: flex;
        flex-direction: row;
        align-items: center;
        padding: 0;

        flex: none;
        order: 1;
        flex-grow: 1;

        font-weight: 600;
    }

    .tag-name {
        /* Inside auto layout */
        flex: none;
        order: 0;
        flex-grow: 0;
        margin-right: 4px;
        transition: all 300ms ease;
        border-radius: 4px;
    }

    .tree .counter {
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        padding: 0 6px;
        font-weight: 600;
        font-size: 12px;
        line-height: 18px;
        color: rgba(0, 0, 0, 0.85);
        background: rgba(0, 0, 0, 0.06);
        border-radius: 16px;
        min-width: 8px;
        font-family: Avenir, -apple-system, serif;
    }

    .counter-zero {
        font-weight: 400 !important;
        color: rgba(0, 0, 0, 0.25) !important;
        background: rgba(0, 0, 0, 0.03) !important;
    }

    .rotate-0 {
        transform: rotate(0deg);
    }

    .rotate-90 {
        transform: rotate(90deg);
    }

    .tree .sub-type {
        padding-bottom: 8px;
    }

    .tree .sub-type .sub-type-title {
        color: rgba(0, 0, 0, .45);
        padding: 0 0 4px 24px;
        font-size: 12px;
    }

    .tree>ul>li>ul {
        /* Auto layout */
        display: flex;
        flex-direction: column;
        align-items: flex-start;
        padding: 0;
        margin: 0;
        /* Inside auto layout */
        flex: none;
        order: 0;
        align-self: stretch;
        flex-grow: 0;
    }

    .tree>ul>li>ul>li {
        /* Auto layout */
        display: flex;
        flex-direction: row;
        justify-content: space-between;
        align-items: center;
        padding: 5px 8px 5px 24px;
        /* Inside auto layout */
        flex: none;
        order: 1;
        align-self: stretch;
        flex-grow: 0;
        margin: 0 0;

        transition: background-color 100ms ease;
        border-radius: 3px;
    }

    .tree>ul>li>ul>li:hover {
        background-color: rgba(0, 0, 0, 0.05);
    }

    .li-selected {
        background-color: #FAFAFA;
        border-radius: 0;
    }

    .tag {
        display: flex;
        flex-direction: row;
        align-items: center;
        padding: 0 8px;

        border-radius: 3px;
        background-color: #E3E2E0;

        color: rgba(0, 0, 0, .85);
        font-size: 12px;
        line-height: 18px;

        user-select: none;
    }

    .tag svg {
        padding: 0 4px 0 2px;
        cursor: pointer;
    }

    .tree .tag {
        /* Inside auto layout */
        flex: none;
        order: 0;
        flex-grow: 0;
    }

    .tag-adding {
        display: flex !important;
        flex-direction: row;
        align-items: center;
        padding: 5px 2px 5px 24px;
    }

    .tag-adding .input {
        flex: none;
        order: 0;
        flex-grow: 1;
        margin: 0;
        height: 26px;
        font-size: 12px;
        line-height: 18px;
    }

    .tag-adding .button {
        flex: none;
        flex-grow: 0;
        margin-left: 4px;
        padding: 6px;
        height: 26px;
    }

    /* TAGS */
    .tag-default {
        background-color: rgba(227, 226, 224, 0.5) !important;
        color: rgb(50, 48, 44) !important;
    }
    .tag-gray {
        background-color: rgb(227, 226, 224) !important;
        color: rgb(50, 48, 44) !important;
    }
    .tag-brown {
        background-color: rgb(238, 224, 218) !important;
        color: rgb(68, 42, 30) !important;
    }
    .tag-orange {
        background-color: rgb(250, 222, 201) !important;
        color: rgb(73, 41, 14) !important;
    }
    .tag-yellow {
        background-color: rgb(253, 236, 200) !important;
        color: rgb(64, 44, 27) !important;
    }
    .tag-green {
        background-color: rgb(219, 237, 219) !important;
        color: rgb(28, 56, 41) !important;
    }
    .tag-blue {
        background-color: rgb(211, 229, 239) !important;
        color: rgb(24, 51, 71) !important;
    }
    .tag-purple {
        background-color: rgb(232, 222, 238) !important;
        color: rgb(65, 36, 84) !important;
    }
    .tag-pink {
        background-color: rgb(245, 224, 233) !important;
        color: rgb(76, 35, 55) !important;
    }
    .tag-red {
        background-color: rgb(255, 226, 221) !important;
        color: rgb(93, 23, 21) !important;
    }

    .select-empty {
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        padding: 0 0 24px;
        height: calc(100vh - 178px);

        flex: none;
        order: 1;
        align-self: stretch;
        flex-grow: 1;
        margin: 0 0;

        font-size: 14px;
        font-weight: 400;
        line-height: 18px;
        color: rgba(0, 0, 0, .85);
        text-align: center;
    }

    .select-empty p {
        margin: 16px 0 0;
    }

    .page-node {
        margin: 0;
        padding: 0;
        background-color: #EDEDED;
    }

    .page-node .page-node-bar {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        /* Auto layout */
        display: flex;
        flex-direction: row;
        align-items: center;
        padding: 0;
        background: rgba(255, 255, 255, .9);
        backdrop-filter: blur(16px);
        user-select: none;
        border-bottom: 1px #E0E0E0 solid;
        z-index: 999;
    }

    .page-node .page-node-bar>div {
        padding: 10px;
        /* Inside auto layout */
        flex: none;
        flex-grow: 0;
        margin: 0;
        border-right: 1px solid #E0E0E0;
        transition: background-color 100ms ease;
        cursor: pointer;
    }

    .page-node .page-node-bar>div:hover {
        background: rgba(0, 0, 0, 0.05);
    }

    .page-node .page-node-bar>p {
        /* Inside auto layout */
        flex: none;
        flex-grow: 1;
        margin: 0;

        padding: 8px 12px;
        font-weight: 500;
        font-size: 12px;
        line-height: 18px;
        color: rgba(0, 0, 0, .85);
        overflow: hidden;
        text-overflow:ellipsis;
        white-space: nowrap;
    }

    .page-node ul {
        padding: 42px 0 16px 0;
        background-color: #EDEDED;
    }

    .node-tag {

    }

    .node-tag-loading {
        background-color: rgba(255, 255, 255, 0.5);
        border-radius: 4px;
        height: 178px;
        display: flex !important;
        flex-direction: column !important;
        justify-content: center !important;
        align-items: center !important;
    }

    .node-tag-loading p {
        font-size: 12px;
        font-weight: 400;
        color: rgba(0, 0, 0, 0.25);
        padding: 0;
        margin: 0 0 8px 0;
    }

    .node-tag-title {
        padding: 12px 16px;
        display: flex;
        flex-direction: row;
        justify-content: space-between;
        align-items: flex-start;
    }

    .node-tag-title .tag {
        flex: none;
        order: 0;
        flex-grow: 0;
    }

    .node-tag ul {
        margin: 0;
        list-style: none;
        display: flex;
        flex-direction: row;
        align-items: stretch;
        padding: 0 0 8px 16px;
        width: calc(100% - 16px);
        overflow-y: hidden;
    }

    .node-tag li {
        width: calc(100vw - 32px);
        padding: 0;
        margin-right: 8px;
        /* Inside auto layout */
        flex: none;
        flex-grow: 0;
        display: flex;
        align-items: stretch;
    }

    .node {
        background: white;
        border-radius: 4px;
        /* Auto layout */
        display: flex;
        flex-direction: column;
        align-items: flex-start;
        padding: 0;
        overflow: hidden;
        text-decoration: none;
        transition: box-shadow 300ms ease;
        flex: 1;
    }

    .node:hover {
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .node .node-img {
        flex: none;
        order: 0;
        align-self: stretch;
        flex-grow: 0;
        margin: 0 0;
        height: 144px;

        overflow: hidden;

        background-position: center center !important;
        background-repeat: no-repeat !important;
        background-size: cover !important;
    }

    .node p {
        padding: 8px;
        /* Inside auto layout */
        flex: none;
        order: 1;
        align-self: stretch;
        flex-grow: 1;
        margin: 0;
        font-size: 12px;
        line-height: 18px;
        color: rgba(0, 0, 0, .85);
    }

    .dropdown {
        display: flex;
        flex-direction: column;
        align-items: center;
    }

    .dropdown .dropdown-entry {
        padding: 10px;
    }

    .menu {
        position: absolute;
        top: 42px;
        right: 2px;
        border-radius: 4px;
        background: white;
        box-shadow: 0 2px 8px rgba(0, 0, 0, .1);
        padding: 4px 0;
    }

    .menu-item {
        display: flex;
        cursor: pointer;
        padding: 6px 12px;
        font-size: 14px;
        line-height: 22px;
        color: rgba(0, 0, 0, .85);
    }

    .menu-item:hover {
        background: #f0f0f0;
    }

    .tooltip {
        font-size: 12px;
        color: white;
        background: rgba(0, 0, 0, .65);
        padding: 4px 8px;
        border-radius: 4px;
        backdrop-filter: blur(4px);
        animation-name: easein;
        animation-duration: 300ms;
    }

</style>

<div id="app">
    <page-node
            v-if="view"
            v-bind:tag-type="view"
            v-bind:tags="full_tags[view]"
            v-bind:tokens="tokens"
            v-on:close="view = undefined"
    >
    </page-node>
    <token-settings
            class="settings"
            v-bind:subtitle="tokens_setting_intro"
            v-if="tokens_setting_show"
            v-bind:allow-cancel="tokens_inited"
            v-bind:tokens="{ figma_token: tokens.figma_token, notion_token: tokens.notion_token, notion_database: tokens.notion_database, oss: tokens.oss }"
            v-on:save="saveTokens"
            v-on:cancel="tokens_setting_show = !tokens_setting_show"
            v-on:test-clear-local-storage="testClearLocalStorage"
    >
    </token-settings>
    <div v-if="!view && !tokens_setting_show">
        <div class="current-select">
            <div class="current-select-name">
                <svg v-show="!figma_node.frame" width="15" height="15" viewBox="0 0 15 15" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <g clip-path="url(#clip0_147_100)">
                        <path d="M12.0888 4.50804L9.20667 1.62589C9.12631 1.54554 9.01783 1.5 8.90399 1.5H3.2147C2.97765 1.5 2.78613 1.69152 2.78613 1.92857V13.0714C2.78613 13.3085 2.97765 13.5 3.2147 13.5H11.7861C12.0232 13.5 12.2147 13.3085 12.2147 13.0714V4.81205C12.2147 4.69821 12.1692 4.58839 12.0888 4.50804ZM11.2263 5.00893H8.70578V2.48839L11.2263 5.00893ZM11.2504 12.5357H3.75042V2.46429H7.79506V5.35714C7.79506 5.50633 7.85433 5.6494 7.95981 5.75489C8.0653 5.86038 8.20838 5.91964 8.35756 5.91964H11.2504V12.5357Z" fill="black" fill-opacity="0.85"/>
                    </g>
                    <defs>
                        <clipPath id="clip0_147_100">
                            <rect width="12" height="12" fill="white" transform="translate(1.5 1.5)"/>
                        </clipPath>
                    </defs>
                </svg>
                <svg v-show="figma_node.frame" width="15" height="15" viewBox="0 0 14 14" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M1.5 5H12.5V4H1.5V5Z" fill="#333333"/>
                    <path d="M1.5 10H12.5V9H1.5V10Z" fill="#333333"/>
                    <path d="M4 1.5V12.5H5V1.5H4Z" fill="#333333"/>
                    <path d="M9 1.5V12.5H10V1.5H9Z" fill="#333333"/>
                </svg>
                <p> {{ figma_node ? figma_node.name : '...' }} </p>
            </div>
            <button v-on:click="refresh" class="current-select-icon">
                <svg width="14" height="14" viewBox="0 0 14 14" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M13.2048 2.27031L12.3236 2.95938C11.122 1.42344 9.25325 0.4375 7.15482 0.4375C3.53138 0.4375 0.598565 3.36719 0.593878 6.99219C0.58919 10.6203 3.52825 13.5625 7.15482 13.5625C9.98763 13.5625 12.4017 11.7656 13.3204 9.24844C13.3439 9.18281 13.3095 9.10938 13.2439 9.0875L12.3579 8.78281C12.3271 8.77223 12.2932 8.77415 12.2638 8.78816C12.2343 8.80218 12.2114 8.82718 12.2001 8.85781C12.172 8.93594 12.1408 9.01406 12.1079 9.09063C11.8376 9.73125 11.4501 10.3063 10.9564 10.8C10.4666 11.2907 9.88673 11.6822 9.24857 11.9531C8.58763 12.2328 7.88294 12.375 7.15794 12.375C6.43138 12.375 5.72825 12.2328 5.06731 11.9531C4.42853 11.6834 3.84844 11.2917 3.3595 10.8C2.86841 10.3103 2.47729 9.72972 2.20794 9.09063C1.92825 8.42813 1.78607 7.725 1.78607 6.99844C1.78607 6.27188 1.92825 5.56875 2.20794 4.90625C2.47825 4.26563 2.86575 3.69063 3.3595 3.19688C3.85325 2.70313 4.42825 2.31563 5.06731 2.04375C5.72825 1.76406 6.43294 1.62188 7.15794 1.62188C7.8845 1.62188 8.58763 1.76406 9.24857 2.04375C9.88735 2.31351 10.4674 2.70519 10.9564 3.19688C11.1111 3.35156 11.2564 3.51563 11.3908 3.6875L10.4501 4.42188C10.4315 4.43627 10.4173 4.45563 10.4092 4.47772C10.4011 4.49981 10.3995 4.52374 10.4043 4.54676C10.4092 4.56977 10.4205 4.59094 10.4369 4.60782C10.4533 4.6247 10.4741 4.63661 10.497 4.64219L13.2408 5.31406C13.3189 5.33281 13.3954 5.27344 13.3954 5.19375L13.4079 2.36719C13.4064 2.26406 13.2861 2.20625 13.2048 2.27031V2.27031Z" fill="black" fill-opacity="0.85"/>
                </svg>
            </button>
            <button v-on:click="tokens_setting_show=true" class="current-select-icon" style="border-left: 1px #E0E0E0 solid">
                <svg width="14" height="14" viewBox="0 0 14 14" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <g clip-path="url(#clip0_132_42)">
                        <path d="M13.4498 8.77885L12.4264 7.90385C12.4748 7.60697 12.4998 7.30384 12.4998 7.00072C12.4998 6.6976 12.4748 6.39447 12.4264 6.0976L13.4498 5.2226C13.527 5.15651 13.5823 5.06849 13.6082 4.97025C13.6342 4.872 13.6296 4.76818 13.5951 4.6726L13.5811 4.63197C13.2993 3.84451 12.8774 3.11453 12.3358 2.47728L12.3076 2.44447C12.2419 2.36721 12.1544 2.31167 12.0565 2.28517C11.9586 2.25867 11.8549 2.26246 11.7592 2.29603L10.4889 2.7476C10.0201 2.36322 9.49671 2.0601 8.93108 1.8476L8.68577 0.51947C8.66726 0.419536 8.61879 0.327599 8.54678 0.255873C8.47478 0.184147 8.38265 0.136028 8.28265 0.117908L8.24046 0.110095C7.4264 -0.0367798 6.57015 -0.0367798 5.75608 0.110095L5.7139 0.117908C5.61389 0.136028 5.52177 0.184147 5.44976 0.255873C5.37776 0.327599 5.32928 0.419536 5.31077 0.51947L5.0639 1.85385C4.50278 2.06639 3.98025 2.36935 3.51702 2.75072L2.23733 2.29603C2.14165 2.26219 2.03794 2.25827 1.93998 2.28478C1.84202 2.3113 1.75444 2.36699 1.68889 2.44447L1.66077 2.47728C1.11975 3.11498 0.69792 3.84484 0.415457 4.63197L0.401395 4.6726C0.331082 4.86791 0.388895 5.08666 0.546707 5.2226L1.58264 6.10697C1.53421 6.40072 1.51077 6.70072 1.51077 6.99916C1.51077 7.29916 1.53421 7.59916 1.58264 7.89135L0.546707 8.77572C0.469513 8.8418 0.414264 8.92982 0.388307 9.02807C0.36235 9.12631 0.366915 9.23013 0.401395 9.32572L0.415457 9.36635C0.69827 10.1538 1.11702 10.8804 1.66077 11.521L1.68889 11.5538C1.7546 11.6311 1.84218 11.6866 1.94009 11.7131C2.03799 11.7396 2.14162 11.7359 2.23733 11.7023L3.51702 11.2476C3.98265 11.6304 4.50296 11.9335 5.0639 12.1445L5.31077 13.4788C5.32928 13.5788 5.37776 13.6707 5.44976 13.7424C5.52177 13.8142 5.61389 13.8623 5.7139 13.8804L5.75608 13.8882C6.57763 14.0359 7.41892 14.0359 8.24046 13.8882L8.28265 13.8804C8.38265 13.8623 8.47478 13.8142 8.54678 13.7424C8.61879 13.6707 8.66726 13.5788 8.68577 13.4788L8.93108 12.1507C9.49648 11.9388 10.0229 11.6347 10.4889 11.2507L11.7592 11.7023C11.8549 11.7361 11.9586 11.74 12.0566 11.7135C12.1545 11.687 12.2421 11.6313 12.3076 11.5538L12.3358 11.521C12.8795 10.8788 13.2983 10.1538 13.5811 9.36635L13.5951 9.32572C13.6655 9.13353 13.6076 8.91478 13.4498 8.77885ZM11.317 6.28197C11.3561 6.51791 11.3764 6.7601 11.3764 7.00228C11.3764 7.24447 11.3561 7.48666 11.317 7.72259L11.2139 8.34916L12.3811 9.3476C12.2041 9.75523 11.9808 10.1411 11.7155 10.4976L10.2655 9.98353L9.77483 10.3867C9.4014 10.6929 8.98577 10.9335 8.53577 11.1023L7.94046 11.3257L7.66077 12.8413C7.21947 12.8913 6.77394 12.8913 6.33264 12.8413L6.05296 11.3226L5.46233 11.096C5.01702 10.9273 4.60296 10.6867 4.23265 10.382L3.74202 9.97728L2.28265 10.496C2.01702 10.1382 1.79514 9.75228 1.61702 9.34603L2.79671 8.33822L2.69515 7.71322C2.65765 7.48041 2.63733 7.23978 2.63733 7.00228C2.63733 6.76322 2.65608 6.52416 2.69515 6.29135L2.79671 5.66635L1.61702 4.65853C1.79358 4.25072 2.01702 3.86634 2.28265 3.50853L3.74202 4.02728L4.23265 3.6226C4.60296 3.31791 5.01702 3.07728 5.46233 2.90853L6.05452 2.6851L6.33421 1.16635C6.77327 1.11635 7.22171 1.11635 7.66233 1.16635L7.94202 2.68197L8.53733 2.90541C8.98577 3.07416 9.40296 3.31478 9.7764 3.62103L10.267 4.02416L11.717 3.5101C11.9826 3.86791 12.2045 4.25385 12.3826 4.6601L11.2155 5.65853L11.317 6.28197ZM6.99983 4.09603C5.48108 4.09603 4.24983 5.32728 4.24983 6.84603C4.24983 8.36478 5.48108 9.59603 6.99983 9.59603C8.51858 9.59603 9.74983 8.36478 9.74983 6.84603C9.74983 5.32728 8.51858 4.09603 6.99983 4.09603ZM8.23733 8.08353C8.07502 8.24631 7.88213 8.37539 7.66975 8.46334C7.45738 8.5513 7.2297 8.59639 6.99983 8.59603C6.53265 8.59603 6.09358 8.41322 5.76233 8.08353C5.59956 7.92122 5.47048 7.72833 5.38252 7.51595C5.29457 7.30358 5.24947 7.0759 5.24983 6.84603C5.24983 6.37885 5.43264 5.93978 5.76233 5.60853C6.09358 5.27728 6.53265 5.09603 6.99983 5.09603C7.46702 5.09603 7.90608 5.27728 8.23733 5.60853C8.40011 5.77084 8.52919 5.96373 8.61714 6.17611C8.7051 6.38849 8.75019 6.61616 8.74983 6.84603C8.74983 7.31322 8.56702 7.75228 8.23733 8.08353Z" fill="black" fill-opacity="0.85"/>
                    </g>
                    <defs>
                        <clipPath id="clip0_132_42">
                            <rect width="14" height="14" fill="white"/>
                        </clipPath>
                    </defs>
                </svg>
            </button>
        </div>
        <div class="main">
            <div class="title" v-if="!loading">
                <a v-tooltip="{ content: node.notion_id ? 'Linked' : 'Unlinked', placement: 'bottom', offset: 4}" :href="node.notion_url" target="_blank">
                    <svg v-if="node.notion_id" width="32" height="32" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M5.716 29.218L2.276 24.933C1.45247 23.9125 1.00227 22.6413 1 21.33V5.815C1 3.861 2.564 2.23901 4.58 2.10101L20.532 1.012C21.6865 0.931797 22.8348 1.23901 23.795 1.885L29.399 5.674C29.8888 5.99996 30.291 6.44131 30.5702 6.9592C30.8493 7.4771 30.9969 8.05567 31 8.644V26.284C31 28.196 29.463 29.779 27.488 29.901L9.783 30.99C8.207 31.087 6.684 30.423 5.716 29.217V29.218Z" fill="white"/>
                        <path d="M11.248 13.579V13.376C11.248 12.861 11.661 12.434 12.192 12.398L16.063 12.14L21.417 20.023V13.104L20.039 12.92V12.824C20.039 12.303 20.461 11.874 20.999 11.846L24.522 11.666V12.172C24.5205 12.2892 24.4775 12.4021 24.4006 12.4905C24.3237 12.579 24.2179 12.6373 24.102 12.655L23.254 12.798V24.004L22.191 24.369C21.301 24.675 20.312 24.348 19.804 23.58L14.606 15.737V23.223L16.206 23.529L16.184 23.677C16.114 24.142 15.712 24.494 15.227 24.515L11.248 24.693C11.195 24.193 11.57 23.746 12.087 23.691L12.61 23.636V13.656L11.248 13.579V13.579Z" fill="black"/>
                        <path d="M20.675 2.967L4.72301 4.056C3.76801 4.121 3.02701 4.889 3.02701 5.815V21.33C3.02701 22.2 3.32701 23.045 3.87801 23.732L7.31801 28.017C7.59791 28.3608 7.95601 28.6325 8.3624 28.8096C8.76879 28.9867 9.21166 29.064 9.65401 29.035L27.359 27.945C28.266 27.89 28.972 27.162 28.972 26.283V8.644C28.9705 8.37385 28.9027 8.10819 28.7746 7.87036C28.6464 7.63254 28.4618 7.42982 28.237 7.28L22.633 3.49C22.0567 3.10265 21.3677 2.9186 20.675 2.967V2.967ZM5.51501 6.057C5.29301 5.893 5.39801 5.551 5.67701 5.531L20.782 4.447C21.264 4.413 21.742 4.545 22.131 4.821L25.161 6.968C25.277 7.05 25.223 7.226 25.081 7.233L9.08401 8.103C8.60216 8.1303 8.12586 7.98886 7.73701 7.703L5.51401 6.056L5.51501 6.057ZM8.33401 10.831C8.33401 10.311 8.75401 9.881 9.29001 9.853L26.203 8.931C26.726 8.903 27.167 9.305 27.167 9.811V25.085C27.167 25.604 26.748 26.033 26.213 26.063L9.40701 27.02C8.82501 27.053 8.33401 26.605 8.33401 26.041V10.831V10.831Z" fill="black"/>
                        <rect x="16" y="16" width="16" height="16" rx="8" fill="#20BF64"/>
                        <path d="M29.3578 19.6875H28.4216C28.2904 19.6875 28.1658 19.7478 28.0855 19.8509L22.5636 26.846L19.9158 23.4911C19.8758 23.4402 19.8247 23.3991 19.7665 23.3708C19.7083 23.3425 19.6444 23.3278 19.5797 23.3277H18.6435C18.5538 23.3277 18.5042 23.4308 18.5591 23.5004L22.2274 28.1478C22.3988 28.3647 22.7283 28.3647 22.9011 28.1478L29.4422 19.8589C29.4971 19.7906 29.4475 19.6875 29.3578 19.6875V19.6875Z" fill="white"/>
                    </svg>
                    <svg v-if="!node.notion_id" width="32" height="32" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <g opacity="0.25">
                            <path d="M5.716 29.218L2.276 24.933C1.45247 23.9125 1.00227 22.6413 1 21.33V5.815C1 3.861 2.564 2.23901 4.58 2.10101L20.532 1.012C21.6865 0.931797 22.8348 1.23901 23.795 1.885L29.399 5.674C29.8888 5.99996 30.291 6.44131 30.5702 6.9592C30.8493 7.4771 30.9969 8.05567 31 8.644V26.284C31 28.196 29.463 29.779 27.488 29.901L9.783 30.99C8.207 31.087 6.684 30.423 5.716 29.217V29.218Z" fill="white"/>
                            <path d="M11.248 13.579V13.376C11.248 12.861 11.661 12.434 12.192 12.398L16.063 12.14L21.417 20.023V13.104L20.039 12.92V12.824C20.039 12.303 20.461 11.874 20.999 11.846L24.522 11.666V12.172C24.5205 12.2892 24.4775 12.4021 24.4006 12.4905C24.3237 12.579 24.2179 12.6373 24.102 12.655L23.254 12.798V24.004L22.191 24.369C21.301 24.675 20.312 24.348 19.804 23.58L14.606 15.737V23.223L16.206 23.529L16.184 23.677C16.114 24.142 15.712 24.494 15.227 24.515L11.248 24.693C11.195 24.193 11.57 23.746 12.087 23.691L12.61 23.636V13.656L11.248 13.579V13.579Z" fill="black"/>
                            <path d="M20.675 2.967L4.72301 4.056C3.76801 4.121 3.02701 4.889 3.02701 5.815V21.33C3.02701 22.2 3.32701 23.045 3.87801 23.732L7.31801 28.017C7.59791 28.3608 7.95601 28.6325 8.3624 28.8096C8.76879 28.9867 9.21166 29.064 9.65401 29.035L27.359 27.945C28.266 27.89 28.972 27.162 28.972 26.283V8.644C28.9705 8.37385 28.9027 8.10819 28.7746 7.87036C28.6464 7.63254 28.4618 7.42982 28.237 7.28L22.633 3.49C22.0567 3.10265 21.3677 2.9186 20.675 2.967V2.967ZM5.51501 6.057C5.29301 5.893 5.39801 5.551 5.67701 5.531L20.782 4.447C21.264 4.413 21.742 4.545 22.131 4.821L25.161 6.968C25.277 7.05 25.223 7.226 25.081 7.233L9.08401 8.103C8.60216 8.1303 8.12586 7.98886 7.73701 7.703L5.51401 6.056L5.51501 6.057ZM8.33401 10.831C8.33401 10.311 8.75401 9.881 9.29001 9.853L26.203 8.931C26.726 8.903 27.167 9.305 27.167 9.811V25.085C27.167 25.604 26.748 26.033 26.213 26.063L9.40701 27.02C8.82501 27.053 8.33401 26.605 8.33401 26.041V10.831V10.831Z" fill="black"/>
                        </g>
                        <rect x="16" y="16" width="16" height="16" rx="8" fill="#EBF6FF"/>
                        <path d="M28.2942 19.7053C27.1612 18.5722 25.3277 18.5722 24.196 19.7053L22.8982 21.003L23.5813 21.6861L24.879 20.3883C25.5996 19.6678 26.8156 19.5914 27.6112 20.3883C28.408 21.1852 28.3317 22.3999 27.6112 23.1205L26.3134 24.4182L26.9978 25.1026L28.2956 23.8048C29.4259 22.6718 29.4259 20.8383 28.2942 19.7053V19.7053ZM23.1232 27.6097C22.4027 28.3303 21.1866 28.4066 20.3911 27.6097C19.5942 26.8129 19.6705 25.5981 20.3911 24.8776L21.6889 23.5798L21.0045 22.8955L19.7067 24.1932C18.5737 25.3263 18.5737 27.1597 19.7067 28.2914C20.8397 29.4231 22.6732 29.4245 23.8049 28.2914L25.1027 26.9937L24.4197 26.3106L23.1232 27.6097V27.6097ZM20.6295 19.9463C20.6093 19.9264 20.5821 19.9152 20.5538 19.9152C20.5255 19.9152 20.4983 19.9264 20.4781 19.9463L19.9478 20.4767C19.9278 20.4968 19.9167 20.524 19.9167 20.5524C19.9167 20.5807 19.9278 20.6079 19.9478 20.628L27.3728 28.053C27.4143 28.0946 27.4826 28.0946 27.5241 28.053L28.0545 27.5227C28.096 27.4812 28.096 27.4129 28.0545 27.3713L20.6295 19.9463Z" fill="#166BC7"/>
                    </svg>
                </a>
                <input class="input" v-model="node.name">
            </div>
            <div v-if="Object.values(node.tags).flatMap(type => type.tags).flatMap(child => Object.values(child).flat()).filter(t => t.check).length > 0" class="selected">
                <tag
                        v-for="tag in Object.values(node.tags).flatMap(type => type.tags).flatMap(child => Object.values(child).flat()).filter(t => t.check)"
                        v-bind:tag="tag"
                        v-bind:removable="true"
                        v-on:remove="tag.check = !tag.check"
                >
                </tag>
            </div>
            <div class="tree" v-if="!loading" >
                <div class="select-empty" v-if="node.tags.length === 0">
                    <svg width="72" height="73" viewBox="0 0 72 73" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <rect x="26.5" y="24" width="28" height="5" rx="2.5" fill="#333333"/>
                        <rect x="17.5" y="24" width="5" height="5" rx="2.5" fill="#333333"/>
                        <rect x="26.5" y="34" width="28" height="5" rx="2.5" fill="#333333"/>
                        <rect x="17.5" y="34" width="5" height="5" rx="2.5" fill="#333333"/>
                        <rect x="26.5" y="44" width="28" height="5" rx="2.5" fill="#333333"/>
                        <rect x="17.5" y="44" width="5" height="5" rx="2.5" fill="#333333"/>
                        <path d="M38 3C38 1.89543 37.1046 1 36 1C34.8954 1 34 1.89543 34 3H38ZM34 7C34 8.10457 34.8954 9 36 9C37.1046 9 38 8.10457 38 7H34ZM38 65C38 63.8954 37.1046 63 36 63C34.8954 63 34 63.8954 34 65H38ZM34 70C34 71.1046 34.8954 72 36 72C37.1046 72 38 71.1046 38 70H34ZM2.5 34.5C1.39543 34.5 0.5 35.3954 0.5 36.5C0.5 37.6046 1.39543 38.5 2.5 38.5V34.5ZM7.00422 38.5C8.10879 38.5 9.00422 37.6046 9.00422 36.5C9.00422 35.3954 8.10879 34.5 7.00422 34.5V38.5ZM64.9958 34.5C63.8912 34.5 62.9958 35.3954 62.9958 36.5C62.9958 37.6046 63.8912 38.5 64.9958 38.5V34.5ZM69.5 38.5C70.6046 38.5 71.5 37.6046 71.5 36.5C71.5 35.3954 70.6046 34.5 69.5 34.5V38.5ZM13.7261 11.3977C12.945 10.6167 11.6787 10.6167 10.8977 11.3977C10.1166 12.1788 10.1166 13.4451 10.8977 14.2261L13.7261 11.3977ZM13.8312 17.1597C14.6122 17.9407 15.8786 17.9407 16.6596 17.1597C17.4407 16.3786 17.4407 15.1123 16.6596 14.3312L13.8312 17.1597ZM57.6688 55.3404C56.8877 54.5593 55.6214 54.5593 54.8403 55.3404C54.0593 56.1214 54.0593 57.3878 54.8403 58.1688L57.6688 55.3404ZM58.2738 61.6023C59.0549 62.3833 60.3212 62.3833 61.1022 61.6023C61.8833 60.8212 61.8833 59.5549 61.1022 58.7739L58.2738 61.6023ZM61.1023 14.2261C61.8834 13.4451 61.8834 12.1788 61.1023 11.3977C60.3213 10.6167 59.055 10.6167 58.2739 11.3977L61.1023 14.2261ZM55.3404 14.3312C54.5593 15.1123 54.5593 16.3786 55.3404 17.1597C56.1214 17.9407 57.3878 17.9407 58.1688 17.1597L55.3404 14.3312ZM17.1597 58.1688C17.9407 57.3878 17.9407 56.1214 17.1597 55.3404C16.3786 54.5593 15.1123 54.5593 14.3312 55.3404L17.1597 58.1688ZM10.8978 58.7739C10.1167 59.5549 10.1167 60.8212 10.8978 61.6023C11.6788 62.3833 12.9451 62.3833 13.7262 61.6023L10.8978 58.7739ZM34 3V7H38V3H34ZM34 65V70H38V65H34ZM2.5 38.5H7.00422V34.5H2.5V38.5ZM64.9958 38.5H69.5V34.5H64.9958V38.5ZM10.8977 14.2261L13.8312 17.1597L16.6596 14.3312L13.7261 11.3977L10.8977 14.2261ZM54.8403 58.1688L58.2738 61.6023L61.1022 58.7739L57.6688 55.3404L54.8403 58.1688ZM58.2739 11.3977L55.3404 14.3312L58.1688 17.1597L61.1023 14.2261L58.2739 11.3977ZM14.3312 55.3404L10.8978 58.7739L13.7262 61.6023L17.1597 58.1688L14.3312 55.3404Z" fill="#18A0FB" fill-opacity="0.5"/>
                    </svg>
                    <p>Create <strong>Multi-Select</strong> properties <br>in Notion to continue.</p>
                </div>
                <ul v-for="(tagType, tagTypeIndex) in node.tags">
                    <div v-on:click="toggleType(tagType)" @mouseover="tagType.hover = true" @mouseleave="tagType.hover = false">
                        <svg class="icon-fold" v-bind:class="{ 'rotate-0': !tagType.open, 'rotate-90': tagType.open }" width="12" height="12" viewBox="0 0 12 12" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M8.38828 5.78337L3.92578 1.93493C3.75938 1.79196 3.51562 1.92087 3.51562 2.15173V9.84861C3.51562 10.0795 3.75938 10.2084 3.92578 10.0654L8.38828 6.21696C8.51602 6.10681 8.51602 5.89353 8.38828 5.78337Z" fill="black" fill-opacity="0.85"/>
                        </svg>
                        <span>
                            <span class="tag-name"> {{ tagType.type }} </span>
                            <span class="counter" v-bind:class="{ 'counter-zero': Object.values(tagType.tags).flat().filter(t => t.check).length === 0 }"> {{ Object.values(tagType.tags).flat().filter(t => t.check).length }} </span>
                        </span>
                        <div class="tree-extra-area">
                            <div class="tree-extra-operation"
                                 v-if="tagTypeIndex > 0"
                                 v-show="tagType.hover"
                                 v-on:click="sortUp(tagType.type)"
                                 v-on:click.stop
                                 v-tooltip="{ content: 'Move up', offset: 4 }"
                            >
                                <svg width="14" height="14" viewBox="0 0 14 14" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M12.5629 7.52289L7.37697 1.54632C7.3301 1.49224 7.27214 1.44887 7.20704 1.41915C7.14193 1.38942 7.0712 1.37404 6.99963 1.37404C6.92806 1.37404 6.85733 1.38942 6.79222 1.41915C6.72712 1.44887 6.66916 1.49224 6.62229 1.54632L1.43791 7.52289C1.42225 7.5409 1.41209 7.56304 1.40865 7.58666C1.40521 7.61029 1.40863 7.6344 1.41851 7.65614C1.42839 7.67787 1.44431 7.69631 1.46437 7.70925C1.48443 7.72219 1.50779 7.7291 1.53166 7.72914H2.79729C2.86916 7.72914 2.93791 7.69789 2.98635 7.6432L6.40666 3.70101V12.4995C6.40666 12.5682 6.46291 12.6245 6.53166 12.6245H7.46916C7.53791 12.6245 7.59416 12.5682 7.59416 12.4995V3.70101L11.0145 7.6432C11.0613 7.69789 11.1301 7.72914 11.2035 7.72914H12.4692C12.5754 7.72914 12.6332 7.60414 12.5629 7.52289Z" fill="black" fill-opacity="0.45"/>
                                </svg>
                            </div>
                            <div class="tree-extra-operation"
                                 v-if="tagTypeIndex < node.tags.length - 1"
                                 v-show="tagType.hover"
                                 v-on:click="sortDown(tagType.type)"
                                 v-on:click.stop
                                 v-tooltip="{ content: 'Move down', offset: 4 }"
                            >
                                <svg width="14" height="14" viewBox="0 0 14 14" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M12.4686 6.27103H11.203C11.1311 6.27103 11.0623 6.30228 11.0139 6.35696L7.59359 10.2992V1.50071C7.59359 1.43196 7.53734 1.37571 7.46859 1.37571H6.53109C6.46234 1.37571 6.40609 1.43196 6.40609 1.50071V10.2992L2.98577 6.35696C2.9389 6.30228 2.87015 6.27103 2.79671 6.27103H1.53109C1.42484 6.27103 1.36702 6.39759 1.43734 6.47728L6.62327 12.4538C6.67015 12.5079 6.72811 12.5513 6.79321 12.581C6.85831 12.6107 6.92905 12.6261 7.00062 12.6261C7.07219 12.6261 7.14292 12.6107 7.20802 12.581C7.27313 12.5513 7.33108 12.5079 7.37796 12.4538L12.5623 6.47728C12.6326 6.39603 12.5748 6.27103 12.4686 6.27103Z" fill="black" fill-opacity="0.45"/>
                                </svg>
                            </div>
                            <div class="tree-extra-operation"
                                 v-show="tagType.hover"
                                 v-on:click="openView(tagType.type)"
                                 v-on:click.stop
                                 v-tooltip="{ content: 'Look up', offset: 4 }"
                            >
                                <svg width="14" height="14" viewBox="0 0 14 14" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <g clip-path="url(#clip0_250_60)">
                                        <path d="M13.5 1.51753H9.925C9.15781 1.51753 8.40781 1.73784 7.7625 2.15346L7 2.64253L6.2375 2.15346C5.59283 1.73792 4.84199 1.51712 4.075 1.51753H0.5C0.223437 1.51753 0 1.74096 0 2.01753V10.8925C0 11.1691 0.223437 11.3925 0.5 11.3925H4.075C4.84219 11.3925 5.59219 11.6128 6.2375 12.0285L6.93125 12.4753C6.95156 12.4878 6.975 12.4957 6.99844 12.4957C7.02187 12.4957 7.04531 12.4894 7.06563 12.4753L7.75937 12.0285C8.40625 11.6128 9.15781 11.3925 9.925 11.3925H13.5C13.7766 11.3925 14 11.1691 14 10.8925V2.01753C14 1.74096 13.7766 1.51753 13.5 1.51753ZM4.075 10.2675H1.125V2.64253H4.075C4.62812 2.64253 5.16562 2.80034 5.62969 3.09878L6.39219 3.58784L6.5 3.65815V10.8769C5.75625 10.4769 4.925 10.2675 4.075 10.2675ZM12.875 10.2675H9.925C9.075 10.2675 8.24375 10.4769 7.5 10.8769V3.65815L7.60781 3.58784L8.37031 3.09878C8.83438 2.80034 9.37188 2.64253 9.925 2.64253H12.875V10.2675ZM5.20156 4.64253H2.29844C2.2375 4.64253 2.1875 4.69565 2.1875 4.75971V5.46284C2.1875 5.5269 2.2375 5.58003 2.29844 5.58003H5.2C5.26094 5.58003 5.31094 5.5269 5.31094 5.46284V4.75971C5.3125 4.69565 5.2625 4.64253 5.20156 4.64253ZM8.6875 4.75971V5.46284C8.6875 5.5269 8.7375 5.58003 8.79844 5.58003H11.7C11.7609 5.58003 11.8109 5.5269 11.8109 5.46284V4.75971C11.8109 4.69565 11.7609 4.64253 11.7 4.64253H8.79844C8.7375 4.64253 8.6875 4.69565 8.6875 4.75971ZM5.20156 6.83003H2.29844C2.2375 6.83003 2.1875 6.88315 2.1875 6.94721V7.65034C2.1875 7.7144 2.2375 7.76753 2.29844 7.76753H5.2C5.26094 7.76753 5.31094 7.7144 5.31094 7.65034V6.94721C5.3125 6.88315 5.2625 6.83003 5.20156 6.83003ZM11.7016 6.83003H8.79844C8.7375 6.83003 8.6875 6.88315 8.6875 6.94721V7.65034C8.6875 7.7144 8.7375 7.76753 8.79844 7.76753H11.7C11.7609 7.76753 11.8109 7.7144 11.8109 7.65034V6.94721C11.8125 6.88315 11.7625 6.83003 11.7016 6.83003Z" fill="black" fill-opacity="0.45"/>
                                    </g>
                                    <defs>
                                        <clipPath id="clip0_250_60">
                                            <rect width="14" height="14" fill="white"/>
                                        </clipPath>
                                    </defs>
                                </svg>
                            </div>
                            <div class="tree-extra-operation"
                                 v-on:click="toggleAdding(tagType)"
                                 v-tooltip="{ content: 'Add tag', offset: 4 }"
                            >
                                <svg width="14" height="14" viewBox="0 0 14 14" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M4.12489 7.50072H6.49989V9.87572C6.49989 9.94447 6.55614 10.0007 6.62489 10.0007H7.37489C7.44364 10.0007 7.49989 9.94447 7.49989 9.87572V7.50072H9.87489C9.94364 7.50072 9.99989 7.44447 9.99989 7.37572V6.62572C9.99989 6.55697 9.94364 6.50072 9.87489 6.50072H7.49989V4.12572C7.49989 4.05697 7.44364 4.00072 7.37489 4.00072H6.62489C6.55614 4.00072 6.49989 4.05697 6.49989 4.12572V6.50072H4.12489C4.05614 6.50072 3.99989 6.55697 3.99989 6.62572V7.37572C3.99989 7.44447 4.05614 7.50072 4.12489 7.50072Z" fill="black" fill-opacity="0.85"/>
                                    <path d="M12.7502 0.750244H1.25024C0.973682 0.750244 0.750244 0.973682 0.750244 1.25024V12.7502C0.750244 13.0268 0.973682 13.2502 1.25024 13.2502H12.7502C13.0268 13.2502 13.2502 13.0268 13.2502 12.7502V1.25024C13.2502 0.973682 13.0268 0.750244 12.7502 0.750244ZM12.1252 12.1252H1.87524V1.87524H12.1252V12.1252Z" fill="black" fill-opacity="0.85"/>
                                </svg>
                            </div>
                        </div>
                    </div>
                    <li class="tag-adding" v-if="tagType.adding">
                        <input class="input" v-focus v-model="tagType.addingText" placeholder="The tag name">
                        <button class="button button-secondary" v-on:click="tagType.adding = false">
                            <svg width="14" height="14" viewBox="0 0 14 14" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M7.80913 6.99929L11.9107 2.11022C11.9794 2.02897 11.9216 1.90554 11.8154 1.90554H10.5685C10.4951 1.90554 10.4248 1.93835 10.3763 1.9946L6.99351 6.02741L3.6107 1.9946C3.56382 1.93835 3.49351 1.90554 3.41851 1.90554H2.17163C2.06538 1.90554 2.00757 2.02897 2.07632 2.11022L6.17788 6.99929L2.07632 11.8883C2.06092 11.9065 2.05104 11.9286 2.04785 11.9522C2.04467 11.9757 2.04831 11.9997 2.05834 12.0213C2.06838 12.0428 2.08439 12.061 2.10447 12.0737C2.12455 12.0865 2.14786 12.0932 2.17163 12.093H3.41851C3.49195 12.093 3.56226 12.0602 3.6107 12.004L6.99351 7.97116L10.3763 12.004C10.4232 12.0602 10.4935 12.093 10.5685 12.093H11.8154C11.9216 12.093 11.9794 11.9696 11.9107 11.8883L7.80913 6.99929Z" fill="black" fill-opacity="0.65"/>
                            </svg>
                        </button>
                        <button class="button button-primary" v-on:click="addTag(tagType)">
                            <svg width="14" height="14" viewBox="0 0 14 14" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M13.2507 1.96875H12.1586C12.0054 1.96875 11.8601 2.03906 11.7664 2.15937L5.32418 10.3203L2.23512 6.40625C2.18839 6.34692 2.12882 6.29895 2.0609 6.26593C1.99297 6.23292 1.91845 6.21572 1.84293 6.21563H0.750741C0.646054 6.21563 0.588241 6.33594 0.652304 6.41719L4.93199 11.8391C5.13199 12.0922 5.51637 12.0922 5.71793 11.8391L13.3492 2.16875C13.4132 2.08906 13.3554 1.96875 13.2507 1.96875V1.96875Z" fill="white"/>
                            </svg>
                        </button>
                    </li>
                    <li v-for="(childTags, childTagType) in tagType.tags" v-if="tagType.open">
                        <ul v-if="childTags.length > 0" class="sub-type">
                            <div class="sub-type-title" v-if="childTagType"> {{ childTagType }} </div>
                            <li v-bind:class="{ 'li-selected': tag.check }" v-for="tag in childTags" v-on:click="tag.check = !tag.check">
                                <span class="tag" v-bind:class="'tag-' + tag.color"> {{ tag.name }} </span>
                                <svg v-if="tag.check" width="14" height="14" viewBox="0 0 14 14" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M13.2507 1.96875H12.1586C12.0054 1.96875 11.8601 2.03906 11.7664 2.15937L5.32418 10.3203L2.23512 6.40625C2.18839 6.34692 2.12882 6.29895 2.0609 6.26593C1.99297 6.23292 1.91845 6.21572 1.84293 6.21563H0.750741C0.646054 6.21563 0.588241 6.33594 0.652304 6.41719L4.93199 11.8391C5.13199 12.0922 5.51637 12.0922 5.71793 11.8391L13.3492 2.16875C13.4132 2.08906 13.3554 1.96875 13.2507 1.96875V1.96875Z" fill="black" fill-opacity="0.65"/>
                                </svg>
                            </li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>

        <div class="footer">
            <button class="button button-primary" v-if="!loading" v-on:click="pushNode">Save</button>
            <button class="button button-secondary" style="padding: 8px;" v-if="!loading && node.notion_id" v-on:click="deleteNode">
                <svg width="14" height="14" viewBox="0 0 14 14" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M4.62476 1.87358H4.49976C4.56851 1.87358 4.62476 1.81733 4.62476 1.74858V1.87358H9.37476V1.74858C9.37476 1.81733 9.43101 1.87358 9.49976 1.87358H9.37476V2.99858H10.4998V1.74858C10.4998 1.19702 10.0513 0.748581 9.49976 0.748581H4.49976C3.94819 0.748581 3.49976 1.19702 3.49976 1.74858V2.99858H4.62476V1.87358ZM12.4998 2.99858H1.49976C1.22319 2.99858 0.999756 3.22202 0.999756 3.49858V3.99858C0.999756 4.06733 1.05601 4.12358 1.12476 4.12358H2.06851L2.45444 12.2955C2.47944 12.8283 2.92007 13.2486 3.45288 13.2486H10.5466C11.081 13.2486 11.5201 12.8298 11.5451 12.2955L11.931 4.12358H12.8748C12.9435 4.12358 12.9998 4.06733 12.9998 3.99858V3.49858C12.9998 3.22202 12.7763 2.99858 12.4998 2.99858ZM10.4263 12.1236H3.57319L3.19507 4.12358H10.8044L10.4263 12.1236Z" fill="black" fill-opacity="0.85"/>
                </svg>
            </button>

        </div>

        <div class="loading" v-if="loading">
            <loading-icon></loading-icon>
            <p style="padding-bottom: 16px"> {{ loading }} </p>
        </div>

        <div class="empty" v-if="!figma_node">
            <svg width="56" height="56" viewBox="0 0 56 56" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M6 20H50V16H6V20Z" fill="#333333"/>
                <path d="M6 40H50V36H6V40Z" fill="#333333"/>
                <path d="M16 6V50H20V6H16Z" fill="#333333"/>
                <path d="M36 6V50H40V6H36Z" fill="#333333"/>
                <path d="M28.1882 46.8501L25.7681 26.2788C25.6661 25.4114 26.6469 24.8392 27.3518 25.3549L43.8636 37.4368C44.6073 37.981 44.2814 39.1562 43.3636 39.2397L35.4689 39.9574C35.1719 39.9844 34.9025 40.1425 34.7341 40.3886L30.0067 47.2979C29.4848 48.0606 28.2962 47.7679 28.1882 46.8501Z" fill="#333333"/>
                <path d="M24.5267 26.4249L26.9468 46.9961C27.1898 49.0613 29.8641 49.7199 31.0383 48.0038L35.6993 41.1916L43.4768 40.4845C45.5419 40.2968 46.2752 37.6525 44.6017 36.428L28.0899 24.3462C26.504 23.1858 24.2971 24.4733 24.5267 26.4249Z" stroke="white" stroke-opacity="0.9" stroke-width="2.5"/>
            </svg>                
            <p>Select a <strong>Frame</strong> to start</p>
        </div>

    </div>
</div>

<script>

    // 注册一个全局自定义指令 `v-focus`
    Vue.directive('focus', {
        // 当被绑定的元素插入到 DOM 中时……
        inserted: function (el) {
            // 聚焦元素
            el.focus()
        }
    });

    Vue.component('token-settings', {
        props: ['subtitle', 'tokens', 'allowCancel'],
        template: `
          <div style="padding: 12px">
              <div>
                <h2>Setup</h2>
                <p class="sub-title" v-bind:class="{ 'color-red': subtitle }">
                  {{ subtitle ? subtitle : 'Provide tokens to continue.' }}
                </p>
              </div>
              <div class="input-area" style="margin-top: 16px">
                <p>Figma token:</p>
                <input class="input" v-model="tokens.figma_token">
                <p>Notion token:</p>
                <input class="input" v-model="tokens.notion_token">
                <p>Notion database:</p>
                <input class="input" v-model="tokens.notion_database">
                <p>OSS:</p>
                <input class="input" v-model="tokens.oss">
              </div>
              <div class="button-group">
                <button class="button button-primary" v-on:click="save">Save</button>
                <button class="button button-secondary" v-if="allowCancel" v-on:click="cancel">Cancel</button>
                <button class="button button-link" v-on:click="testClearLocalStorage">Clear</button>
              </div>
          </div>`,
        methods: {
            save: function () {
                this.$emit('save', this.tokens);
            },
            cancel: function () {
                this.$emit('cancel');
            },
            testClearLocalStorage: function () {
                this.$emit('test-clear-local-storage');
            }
        }
    });

    Vue.component('loading-icon', {
        template: `
            <svg class="loading-icon" width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M12 24C10.3805 24 8.80781 23.6836 7.32891 23.0578C5.89922 22.4531 4.61719 21.5859 3.51563 20.4844C2.41406 19.3828 1.54688 18.1008 0.942188 16.6711C0.316406 15.1922 0 13.6195 0 12C0 11.5336 0.377344 11.1562 0.84375 11.1562C1.31016 11.1562 1.6875 11.5336 1.6875 12C1.6875 13.3922 1.95938 14.7422 2.49844 16.0148C3.01875 17.243 3.76172 18.3469 4.70859 19.2938C5.65547 20.2406 6.75938 20.9859 7.9875 21.5039C9.25781 22.0406 10.6078 22.3125 12 22.3125C13.3922 22.3125 14.7422 22.0406 16.0148 21.5016C17.243 20.9813 18.3469 20.2383 19.2938 19.2914C20.2406 18.3445 20.9859 17.2406 21.5039 16.0125C22.0406 14.7422 22.3125 13.3922 22.3125 12C22.3125 10.6078 22.0406 9.25781 21.5016 7.98516C20.983 6.75998 20.2325 5.64659 19.2914 4.70625C18.3521 3.76387 17.2385 3.01321 16.0125 2.49609C14.7422 1.95938 13.3922 1.6875 12 1.6875C11.5336 1.6875 11.1563 1.31016 11.1563 0.84375C11.1563 0.377344 11.5336 0 12 0C13.6195 0 15.1922 0.316406 16.6711 0.942188C18.1008 1.54688 19.3828 2.41406 20.4844 3.51562C21.5859 4.61719 22.4508 5.90156 23.0555 7.32891C23.6813 8.80781 23.9977 10.3805 23.9977 12C23.9977 13.6195 23.6813 15.1922 23.0555 16.6711C22.4531 18.1008 21.5859 19.3828 20.4844 20.4844C19.3828 21.5859 18.0984 22.4508 16.6711 23.0555C15.1922 23.6836 13.6195 24 12 24V24Z" fill="black" fill-opacity="0.85"/>
            </svg>
        `
    });

    Vue.component('tag', {
        props: ['tag', 'removable'],
        template: `
          <span class="tag" v-bind:class="'tag-' + tag.color" v-bind:style="{ padding: removable ? '0 0 0 8px' : '0 8px' }">
              {{ tag.name }}
              <svg v-if="removable" v-on:click="tag.check = !tag.check" width="14" height="14" viewBox="0 0 14 14" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M7.57795 6.99949L10.5076 3.5073C10.5567 3.44927 10.5155 3.3611 10.4396 3.3611H9.54894C9.49648 3.3611 9.44626 3.38454 9.41166 3.42472L6.99536 6.3053L4.57907 3.42472C4.54559 3.38454 4.49536 3.3611 4.44179 3.3611H3.55117C3.47527 3.3611 3.43398 3.44927 3.48309 3.5073L6.41277 6.99949L3.48309 10.4917C3.47209 10.5046 3.46503 10.5204 3.46275 10.5373C3.46048 10.5541 3.46308 10.5712 3.47024 10.5866C3.47741 10.602 3.48885 10.615 3.50319 10.6241C3.51754 10.6332 3.53419 10.638 3.55117 10.6379H4.44179C4.49425 10.6379 4.54447 10.6144 4.57907 10.5743L6.99536 7.69369L9.41166 10.5743C9.44514 10.6144 9.49536 10.6379 9.54894 10.6379H10.4396C10.5155 10.6379 10.5567 10.5497 10.5076 10.4917L7.57795 6.99949Z" fill="black" fill-opacity="0.65"/>
              </svg>
          </span>
        `,
        methods: {
            remove: function () {
                this.$emit('remove');
            }
        }
    });

    Vue.component('node', {
        props: ['node'],
        template: `
          <a class="node" v-bind:href="node['properties']['URL']['url']" target="_blank">
            <div class="node-img" v-bind:style="{ background: 'url(' + node.cover['external'].url + ')'}"></div>
            <p> {{ node.properties['Name']['title'][0]['plain_text'] }} </p>
          </a>
        `
    });

    Vue.component('node-tag', {
        props: ['tagType', 'tag', 'tokens'],
        data() {
            return {
                loading: true,
                list: []
            }
        },
        template: `
          <div class="node-tag">
              <div class="node-tag-title">
                <tag v-bind:tag="tag" v-bind:removable="false"></tag>
              </div>
              <ul>
                <li class="node-tag-loading" v-if="loading">
                  <loading-icon style="flex: none; order: 0; flex-grow: 0;"></loading-icon>
                </li>
                <li class="node-tag-loading" v-if="!loading && list.length === 0">
                  <svg width="48" height="48" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M24 38.7773C37.2548 38.7773 48 36.4443 48 33.5663C48 30.6883 37.2548 28.3553 24 28.3553C10.7452 28.3553 0 30.6883 0 33.5663C0 36.4443 10.7452 38.7773 24 38.7773Z" fill="#F5F5F5"/>
                    <path d="M41.25 19.249L33.6405 10.6865C33.2753 10.1029 32.742 9.75 32.1803 9.75H15.8198C15.258 9.75 14.7247 10.1029 14.3595 10.6858L6.75 19.2497V26.1275H41.25V19.249Z" stroke="#D9D9D9" stroke-width="0.75"/>
                    <path d="M31.2097 21.6095C31.2097 20.4147 31.9553 19.4284 32.88 19.4276H41.25V32.9294C41.25 34.5098 40.26 35.8051 39.0375 35.8051H8.9625C7.74 35.8051 6.75 34.5091 6.75 32.9294V19.4276H15.12C16.0447 19.4276 16.7902 20.4125 16.7902 21.6073V21.6237C16.7902 22.8185 17.544 23.7833 18.468 23.7833H29.532C30.456 23.7833 31.2097 22.8096 31.2097 21.6148V21.6095V21.6095Z" fill="#FAFAFA" stroke="#D9D9D9" stroke-width="0.75"/>
                  </svg>
                  <p>Empty</p>
                </li>
                <li v-for="node in list">
                  <node v-bind:node="node"></node>
                </li>
              </ul>
          </div>
        `,
        async created () {
            this.loading = true;
            try {
                const result0 = await fetch('https://notion.easecation.net/database/' + this.tokens.notion_database + "/query", {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json;charset=UTF-8',
                        'notion_token': this.tokens.notion_token,
                    },
                    body: JSON.stringify({
                        filter: {
                            property: this.tagType,
                            multi_select: {
                                contains: this.tag.name
                            }
                        },
                        sorts: [
                            {
                                property: "上线",
                                direction: "ascending"
                            }
                        ]
                    })
                });
                if (result0.ok) {
                    this.loading = false;
                    const result = await result0.json();
                    this.list = result['results'];
                } else {
                    notify("[" + result0.status + "] " + result0.statusText, { error: true });
                }
            } catch (e) {
                notify(e, { error: true });
            }
        }
    });

    Vue.component('page-node', {
        props: ['tagType', 'tags', 'tokens'],
        template: `
          <div class="page-node">
            <div class="page-node-bar">
              <div v-on:click="close">
                <svg width="14" height="14" viewBox="0 0 14 14" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M10.3129 2.41058V1.20277C10.3129 1.09808 10.1926 1.04027 10.1113 1.10433L3.06758 6.60589C3.00773 6.65243 2.9593 6.71203 2.92599 6.78013C2.89268 6.84824 2.87537 6.92305 2.87537 6.99886C2.87537 7.07468 2.89268 7.14949 2.92599 7.21759C2.9593 7.28569 3.00773 7.34529 3.06758 7.39183L10.1113 12.8934C10.1941 12.9575 10.3129 12.8996 10.3129 12.795V11.5871C10.3129 11.5106 10.277 11.4371 10.2176 11.3903L4.59258 6.99964L10.2176 2.60745C10.277 2.56058 10.3129 2.48714 10.3129 2.41058V2.41058Z" fill="black" fill-opacity="0.85"/>
                </svg>
              </div>
              <p> {{ tagType }} </p>
<!--              <div v-on:click="refresh">-->
<!--                <svg width="14" height="14" viewBox="0 0 14 14" fill="none" xmlns="http://www.w3.org/2000/svg">-->
<!--                  <path d="M13.2048 2.27031L12.3236 2.95938C11.122 1.42344 9.25325 0.4375 7.15482 0.4375C3.53138 0.4375 0.598565 3.36719 0.593878 6.99219C0.58919 10.6203 3.52825 13.5625 7.15482 13.5625C9.98763 13.5625 12.4017 11.7656 13.3204 9.24844C13.3439 9.18281 13.3095 9.10938 13.2439 9.0875L12.3579 8.78281C12.3271 8.77223 12.2932 8.77415 12.2638 8.78816C12.2343 8.80218 12.2114 8.82718 12.2001 8.85781C12.172 8.93594 12.1408 9.01406 12.1079 9.09063C11.8376 9.73125 11.4501 10.3063 10.9564 10.8C10.4666 11.2907 9.88673 11.6822 9.24857 11.9531C8.58763 12.2328 7.88294 12.375 7.15794 12.375C6.43138 12.375 5.72825 12.2328 5.06731 11.9531C4.42853 11.6834 3.84844 11.2917 3.3595 10.8C2.86841 10.3103 2.47729 9.72972 2.20794 9.09063C1.92825 8.42813 1.78607 7.725 1.78607 6.99844C1.78607 6.27188 1.92825 5.56875 2.20794 4.90625C2.47825 4.26563 2.86575 3.69063 3.3595 3.19688C3.85325 2.70313 4.42825 2.31563 5.06731 2.04375C5.72825 1.76406 6.43294 1.62188 7.15794 1.62188C7.8845 1.62188 8.58763 1.76406 9.24857 2.04375C9.88735 2.31351 10.4674 2.70519 10.9564 3.19688C11.1111 3.35156 11.2564 3.51563 11.3908 3.6875L10.4501 4.42188C10.4315 4.43627 10.4173 4.45563 10.4092 4.47772C10.4011 4.49981 10.3995 4.52374 10.4043 4.54676C10.4092 4.56977 10.4205 4.59094 10.4369 4.60782C10.4533 4.6247 10.4741 4.63661 10.497 4.64219L13.2408 5.31406C13.3189 5.33281 13.3954 5.27344 13.3954 5.19375L13.4079 2.36719C13.4064 2.26406 13.2861 2.20625 13.2048 2.27031V2.27031Z" fill="black" fill-opacity="0.85"/>-->
<!--                </svg>-->
<!--              </div>-->
              <dropdown
                  v-bind:active="active"
                  @toggled="toggleDropDown"
                  @toggle-menu="toggleMenu"
                  style="padding: 0 !important;"
              > </dropdown>
            </div>
            <ul>
              <li v-for="tag in tags">
                <node-tag v-bind:tag-type="tagType" v-bind:tag="tag" v-bind:tokens="tokens"></node-tag>
              </li>
            </ul>
          </div>
        `,
        data() {
            return {
                active: false
            }
        },
        methods: {
            close: function () {
                this.$emit('close');
            },
            toggleMenu(action) {
                console.log(action);
            },
            toggleDropDown() {
                console.log("toggleDropDown");
                this.active = !this.active
            },
        }
    });

    Vue.component('dropdown', {
        template: `
          <div class="dropdown" :class="{'active': active}">
              <div class="dropdown-entry" @click="toggleHandler">
                ...
              </div>

              <div class="menu" v-if="active">
                <menu-item action="test1" @click="handler">
                  test1
                </menu-item>

                <menu-item action="test3" @click="handler">
                  test2
                </menu-item>

                <menu-item action="test3" @click="handler">
                  test3
                </menu-item>

              </div>

          </div>
        `,
        props: {
            active: {
                type: Boolean,
                default: false,
            },
        },

        methods: {
            toggleHandler() {
                this.$emit('toggled');
            },

            handler(action) {
                this.$emit('toggle-menu', action);
            }
        },
    });

    Vue.component('menu-item', {
        template: `
        <div class="menu-item" @click="handler">
          <slot> </slot>
        </div>
        `,
        props: {
            text: {
                type: String,
                default: '',
            },
            action: {
                type: String,
                default: 'hello',
            },
        },

        methods: {
            handler() {
                this.$emit('click', this.action)
            },
        },
    })

    const app = new Vue({
        el: '#app',
        data: {
            figma_node: undefined,
            tokens_inited: false,
            tokens_setting_show: true,
            tokens_setting_intro: undefined,
            tokens: {
                figma_token: '',
                notion_token: '',
                notion_database: '',
                oss: ''
            },
            view: undefined, // 有值时，显示列表
            file: undefined,
            full_tags: {},
            loading: 'Loading...',
            node: {
                notion_id: undefined,
                id: undefined,
                name: '',
                tags: {},
                need_reload_tags: false
            }
        },
        methods: {
            saveTokens: async function (tokens) {
                this.loading = 'Checking tokens...';
                this.tokens_setting_show = false;
                try {
                    await loadTags(tokens);
                } catch (e) {
                    notify('The token is not correct', { error: true });
                    this.loading = undefined;
                    this.tokens_setting_show = true;
                    this.tokens_setting_intro = 'Something wrong: [' + e.status + "] " + e.statusText;
                    return;
                }
                this.tokens_inited = true;
                this.tokens_setting_show = false;
                this.tokens_setting_intro = undefined;
                this.tokens = tokens;
                parent.postMessage({
                    pluginMessage: {
                        type: 'init',
                        figma_token: this.tokens.figma_token,
                        notion_token: this.tokens.notion_token,
                        notion_database: this.tokens.notion_database,
                        oss: this.tokens.oss
                    }
                }, '*');
                if (this.figma_node) {
                    await loadNode(this.file, this.figma_node);
                }
            },
            testClearLocalStorage: function () {
                parent.postMessage({
                    pluginMessage: {
                        type: 'clearLocalStorage'
                    }
                }, '*');
            },
            pushNode: async function () {
                this.loading = "Saving...";
                const tags = tree2Tag(app.node.tags);

                if (app.tokens.oss) { // UI点Save -> 插件导出图片 -> UI中上传截图到OSS -> UI中最终上传到notion
                    this.loading = "Exporting the cover..."
                    const cover = app.tokens.oss + (app.tokens.oss.endsWith("/") ? "" : "/") + app.file + "_" + app.node.id + ".png";
                    parent.postMessage({
                        pluginMessage: {
                            type: 'node-push-oss',
                            node: this.node, // 选中的目标node（用于插件代码中定位Node并且导出）
                            data: { // 最终要post的数据
                                name: app.node.name,
                                tags: tags,
                                cover: cover
                            }
                        }
                    }, '*');
                } else {
                    await pushNodeFinal({
                        name: app.node.name,
                        tags: tags
                    })
                }
            },
            deleteNode: async function (event) {
                this.loading = "Deleting...";
                const result = await fetch('https://notion.easecation.net/node/delete/' + app.file + "/" + app.node.id, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json;charset=UTF-8',
                        'figma_token': app.tokens.figma_token,
                        'notion_token': app.tokens.notion_token,
                        'notion_database': app.tokens.notion_database
                    }
                }).then(d => d.json());
                parent.postMessage({
                    pluginMessage: {
                        type: 'node-delete',
                        node: app.node
                    }
                }, '*');
                this.node.notion_id = undefined;
                this.node.notion_url = undefined;
                notify('Delete success!');
                await loadNode(this.file, this.figma_node);
                parent.postMessage({
                    pluginMessage: {
                        type: 'loading-finish'
                    }
                }, '*');
            },
            refresh: async function (event) {
                if (!this.loading) {
                    this.loading = "Loading Tags...";
                    await loadTags(this.tokens, Object.keys(this.full_tags));
                    await loadNode(this.file, this.figma_node);
                }
            },
            toggleType: function (tagType) {
                tagType.open = tagType.adding || !tagType.open;
            },
            toggleAdding: function (tagType) {
                tagType.adding = !tagType.adding;
            },
            addTag: function (tagType) {
                if (tagType.addingText.length > 0) {
                    const subs = tagType.addingText.replaceAll(' ', '').split('/', 2);
                    const tag = {
                        check: true,
                        color: 'default',
                        id: '',
                        name: tagType.addingText
                    }
                    if (subs.length > 1) {
                        if (!tagType.tags[subs[0]]) {
                            tagType.tags[subs[0]] = [];
                        }
                        tagType.tags[subs[0]].unshift(tag);
                    } else {
                        tagType.tags[''].unshift(tag);
                    }
                    tagType.adding = false;
                    tagType.addingText = '';
                    this.node.need_reload_tags = true;
                }
            },
            sortUp: function (tagType) {
                const sorts = Object.keys(this.full_tags);
                const index = sorts.indexOf(tagType);
                if (index > 0) {
                    sorts.splice(index, 1);
                    sorts.splice(index - 1, 0, tagType);
                }
                loadTagsLocal(this.full_tags, sorts);
                //TODO 刷新this.tags

                const tags = [];
                for (sort of sorts) {
                    for (oldTagType of this.node.tags) {
                        if (oldTagType.type === sort) {
                            tags.push(oldTagType);
                            break;
                        }
                    }
                }
                this.node.tags = tags;
            },
            sortDown: function (tagType) {
                const sorts = Object.keys(this.full_tags);
                const index = sorts.indexOf(tagType);
                if (index >= 0 && index < sorts.length - 1) {
                    sorts.splice(index, 1);
                    sorts.splice(index + 1, 0, tagType);
                }
                loadTagsLocal(this.full_tags, sorts);

                const tags = [];
                for (sort of sorts) {
                    for (oldTagType of this.node.tags) {
                        if (oldTagType.type === sort) {
                            tags.push(oldTagType);
                            break;
                        }
                    }
                }
                this.node.tags = tags;
            },
            openView: async function (tagType) {
                this.view = tagType;
            }
        }
    });

    const loadTags = async (tokens, sorts) => {
        const response = await fetch('https://notion.easecation.net/tags', {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json;charset=UTF-8',
                'figma_token': tokens.figma_token,
                'notion_token': tokens.notion_token,
                'notion_database': tokens.notion_database
            }
        });
        if (!response.ok) {
            throw {
                status: response.status,
                statusText: response.statusText
            };
        }
        const result = await response.json();
        loadTagsLocal(result.result, sorts);
    }

    const loadTagsLocal = (origin, sorts) => {
        const full_tags = {};
        if (sorts) {
            for (sort of sorts) {
                if (!full_tags[sort] && origin[sort]) {
                    full_tags[sort] = [];
                }
            }
        }
        for (let type in origin) {
            if (!full_tags[type]) {
                full_tags[type] = [];
            }
            full_tags[type] = origin[type];
        }
        app.full_tags = full_tags;
        parent.postMessage({
            pluginMessage: {
                type: 'save-tags-type-cache',
                tags: Object.keys(full_tags)
            }
        }, '*');
    }

    const loadNode = async (file, node) => {
        if (!node) return;
        app.file = file;
        app.node.id = node.id;
        app.node.need_reload_tags = false;
        app.loading = "Loading Node...";
        const data = await fetch('https://notion.easecation.net/node/get/' + file + "/" + node.id, {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json;charset=UTF-8',
                'figma_token': app.tokens.figma_token,
                'notion_token': app.tokens.notion_token,
                'notion_database': app.tokens.notion_database
            }
        }).then(d => d.json())

        if (data.result.length > 0) {
            app.node.notion_id = data.result[0].id;
            app.node.notion_url = data.result[0].url;
            app.node.name = data.result[0].name;
            if (app.full_tags) {
                app.node.tags = tags2Tree(app.full_tags, data.result[0]['tags']);
            }
        } else { // 在 Notion 没有找到 Node
            app.node.notion_id = undefined;
            app.node.notoin_url = undefined;
            app.node.name = node.name;
            app.node.tags = tags2Tree(app.full_tags, {});
        }
        app.loading = undefined;
    }

    let tagsArrayDemo = [
        {
            type: "上线",
            open: true,
            hover: false,
            adding: false,
            addingText: '',
            tags: {
                '': [

                ],
                xxx: [
                    {
                        check: true,
                        color: 'tag.color',
                        id: 'tag.id',
                        name: 'tag.name'
                    },
                    {
                        check: false,
                        color: 'tag.color',
                        id: 'tag.id',
                        name: 'tag.name'
                    }
                ]
            }
        }
    ]

    /**
     * @param full_tags Tags config
     * @param node_tags Tags data from Notion API
     * @returns {*[]} Tags data for UI
     */
    const tags2Tree = (full_tags, node_tags) => {
        const tagsArray = [];
        for (let tagType in full_tags) {
            // type
            const tags = {
                '': []  // 把默认组放在最前面
            };
            for (let tag of full_tags[tagType]) {
                const tagNameSubs = tag.name.replaceAll(' ', '').split('/', 2);
                const childTag = tagNameSubs.length > 1 ? tagNameSubs[0] : '';
                if (!tags[childTag]) {
                    tags[childTag] = [];
                }
                const treeTag = {
                    check: false,
                    color: tag.color,
                    id: tag.id,
                    name: tag.name
                };
                tags[childTag].push(treeTag);
            }
            for (let tagKey in tags['']) {
                if (tags[tags[''][tagKey].name]) {
                    tags[tags[''][tagKey].name].unshift(tags[''][tagKey]);
                    tags[''].splice(tagKey, 1);
                }
            }
            // tagType
            let open = true;
            if (app.node && app.node.tags && app.node.tags.length > 0) {
                app.node.tags.filter(e => e.type === tagType).forEach(e => open = e.open);
            }
            let entry = {
                type: tagType,
                open: open, //根据现在有的收起展开
                hover: false,
                adding: false,
                addingText: '',
                tags: tags
            };
            if (Object.keys(node_tags).length > 0) {
                for (let childTag in entry.tags) {
                    for (let tagIndex in entry.tags[childTag]) {
                        for (let tagVaild of node_tags[tagType]) {
                            if (entry.tags[childTag][tagIndex].name === tagVaild.name) {
                                entry.tags[childTag][tagIndex].check = true;
                                break;
                            }
                        }
                    }
                }
            }
            tagsArray.push(entry);
        }
        return tagsArray;
    }

    const tree2Tag = (tree) => {
        const tags = {};
        for (let tagEntry of tree) {
            const array = [];
            for (let childType in tagEntry.tags) {
                for (let tag of tagEntry.tags[childType]) {
                    if (tag.check) {
                        array.push(tag.name);
                    }
                }
            }
            tags[tagEntry.type] = array;
        }
        return tags;
    }

    // Handle figma messages
    onmessage = async (event) => {
        const message = event.data.pluginMessage;
        if (message.tokens) {
            app.tokens = message.tokens;
            app.tokens_inited = true;
        }
        switch (message.type) {
            case 'init': {
                app.figma_node = message.node;
                app.tokens_setting_show = true;
                break;
            }
            case 'normal': {
                app.figma_node = message.node;
                app.tokens_setting_show = false;
                try {
                    await loadTags(app.tokens, message.cached_tag_types);
                } catch (e) {
                    console.error(e);
                    app.tokens_setting_show = true;
                    app.tokens_inited = false;
                    app.tokens_setting_intro = 'Something wrong: [' + e.status + "] " + e.statusText;
                    return;
                }
                await loadNode(message.file, message.node);
                break;
            }
            case 'selectionchange': {
                if (app.loading) return; // Loading 时不接收selectionchange事件，但是会在loading完成后，主动请求刷新
                if (!app.tokens_inited) return;
                if (!app.figma_node || message.node.id !== app.figma_node.id) {
                    app.figma_node = message.node;
                    await loadNode(message.file, message.node);
                    parent.postMessage({
                        pluginMessage: {
                            type: 'loading-finish'
                        }
                    }, '*');
                }
                break;
            }
            case 'push-export': {
                try {
                    app.loading = "Uploading the cover...";
                    const result = await fetch(message.data.cover,
                        {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'image/png'
                            },
                            body: message.image
                        }
                    );
                    if (result.ok) {
                        console.log("OSS upload success!");
                        app.loading = "Saving the node...";
                        await pushNodeFinal(message.node, message.data);
                    } else {
                        console.error("OSS upload failed.");
                        notify("OSS upload failed.", { error: true });
                        console.log(result);
                        app.loading = undefined;
                    }
                } catch (e) {
                    console.error("Node upload failed.");
                    notify("Node upload failed.", { error: true });
                    console.error(e);
                    app.loading = undefined;
                }
                break;
            }
        }
    }

    const notify = (msg, options) => {
        parent.postMessage({
            pluginMessage: {
                type: 'notify',
                msg: msg,
                options: options
            }
        }, '*');
    }

    const pushNodeFinal = async (node, data) => {
        const result0 = await fetch('https://notion.easecation.net/node/push/' + app.file + "/" + app.node.id, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json;charset=UTF-8',
                'figma_token': app.tokens.figma_token,
                'notion_token': app.tokens.notion_token,
                'notion_database': app.tokens.notion_database
            },
            body: JSON.stringify(data)
        });
        if (!result0.ok) {
            app.tokens_setting_show = true;
            app.tokens_setting_intro = 'Something wrong: [' + result0.status + "] " + result0.statusText;
            return;
        }
        const result = await result0.json();
        parent.postMessage({
            pluginMessage: {
                type: 'node-push-suc',
                node: node
            }
        }, '*');
        if (result.result.length > 0) {
            app.node.notion_id = result.result[0].id;
            app.node.notion_url = result.result[0].url;
        }
        if (node.need_reload_tags) {
            app.loading = "Loading Tags...";
            await loadTags(app.tokens, Object.keys(app.full_tags));
            await loadNode(app.file, app.figma_node);
        }
        app.loading = undefined;
        notify(node.name + " Push success!");
        parent.postMessage({
            pluginMessage: {
                type: 'loading-finish'
            }
        }, '*');
    }

</script>
